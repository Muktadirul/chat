!function(){"use strict";var e="undefined"==typeof window?global:window;if("function"!=typeof e.require){var t={},s={},a={},n={}.hasOwnProperty,r=/^\.\.?(\/|$)/,i=function(e,t){for(var s,a=[],n=(r.test(t)?e+"/"+t:t).split("/"),i=0,c=n.length;i<c;i++)s=n[i],".."===s?a.pop():"."!==s&&""!==s&&a.push(s);return a.join("/")},c=function(e){return e.split("/").slice(0,-1).join("/")},o=function(t){return function(s){var a=i(c(t),s);return e.require(a,t)}},u=function(e,t){var a=null;a=_&&_.createHot(e);var n={id:e,exports:{},hot:a};return s[e]=n,t(n.exports,o(e),n),n.exports},d=function(e){return a[e]?d(a[e]):e},l=function(e,t){return d(i(c(e),t))},h=function(e,a){null==a&&(a="/");var r=d(e);if(n.call(s,r))return s[r].exports;if(n.call(t,r))return u(r,t[r]);throw new Error("Cannot find module '"+e+"' from '"+a+"'")};h.alias=function(e,t){a[t]=e};var f=/\.[^.\/]+$/,m=/\/index(\.[^\/]+)?$/,p=function(e){if(f.test(e)){var t=e.replace(f,"");n.call(a,t)&&a[t].replace(f,"")!==t+"/index"||(a[t]=e)}if(m.test(e)){var s=e.replace(m,"");n.call(a,s)||(a[s]=e)}};h.register=h.define=function(e,a){if("object"==typeof e)for(var r in e)n.call(e,r)&&h.register(r,e[r]);else t[e]=a,delete s[e],p(e)},h.list=function(){var e=[];for(var s in t)n.call(t,s)&&e.push(s);return e};var _=e._hmr&&new e._hmr(l,h,t,s);h._cache=s,h.hmr=_&&_.wrap,h.brunch=!0,e.require=h}}(),function(){var e;window;require.register("actions.js",function(e,t,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.initialFetchChats=e.initialFetchUsers=e.initialFetchCurrentUser=e.loadChatMessages=e.createChat=e.stopLoadChatMessages=e.startLoadChatMessages=e.incrementChatMessagesPageNumber=e.initLoadChatMessagesInfo=e.addNewChat=e.changeIsTypingState=e.readChatMessage=e.addNewChatMessage=e.selectChat=void 0;var a=t("utils/apiCalls"),n=t("utils/utils"),r=e.selectChat=function(e){return{type:"SELECT_CHAT",chatId:e}},i=(e.addNewChatMessage=function(e,t){return{type:"ADD_NEW_CHAT_MESSAGE",chatId:e,message:t}},e.readChatMessage=function(e){return{type:"READ_CHAT_MESSAGE",chatId:e}},e.changeIsTypingState=function(e){return{type:"CHANGE_IS_TYPING_STATE",chatId:e}},e.addNewChat=function(e){return{type:"ADD_NEW_CHAT",chat:e}}),c=e.initLoadChatMessagesInfo=function(e){return{type:"INIT_LOAD_CHAT_MESSAGES_INFO",chatId:e}},o=e.incrementChatMessagesPageNumber=function(e){return{type:"INCREMENT_CHAT_MESSAGE_PAGE_NUMBER",chatId:e}},u=(e.startLoadChatMessages=function(e){return{type:"START_LOAD_CHAT_MESSAGES",chatId:e}},e.stopLoadChatMessages=function(e){return{type:"STOP_LOAD_CHAT_MESSAGES",chatId:e}}),d=(e.createChat=function(e){return function(t){(0,a.createChat)(e).then(function(e){if("CHAT_ALREADY_EXISTS"===e.type){var s=e.chat_id;t(d(s)),t(selectedChat(s))}else"CHAT_NEW"===e.type&&!function(){var s=e.chat.chat_id,a=new WebSocket("ws://127.0.0.1:8888/tornado_chat/"+s+"/");(0,n.waitForSocketConnection)(a,function(){a.send(JSON.stringify({type:"DISPLAY_CHAT_ON_RECIPIENT_SIDE",chat:e.chat})),a.close()}),t(i(e.chat)),t(r(s))}()})}},e.loadChatMessages=function(e){return function(t,s){var n=void 0;s().chatMessagesLoadInfo[e]?n=s().chatMessagesLoadInfo[e].pageNumber:(n=0,t(c(e))),(0,a.loadChatMessages)(e,n+1).then(function(s){t({type:"RECEIVE_CHAT_MESSAGES",chatId:e,chatMessages:s}),t(u(e)),n&&t(o(e))})}});e.initialFetchCurrentUser=function(){return function(e){(0,a.getCurrentUser)().then(function(t){e({type:"RECEIVE_CURRENT_USER",user:t})})}},e.initialFetchUsers=function(){return function(e){(0,a.getAllUsers)().then(function(t){e({type:"RECEIVE_USERS",users:t})})}},e.initialFetchChats=function(){return function(e){(0,a.getUserChats)().then(function(t){e({type:"RECEIVE_CHATS",chats:t})})}}}),require.register("components/Chat.jsx",function(e,t,s){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(e,"__esModule",{value:!0});var n=t("react"),r=a(n),i=t("dateformat"),c=a(i);e["default"]=r["default"].createClass({displayName:"Chat",propTypes:{chat:r["default"].PropTypes.object.isRequired,selectedChat:r["default"].PropTypes.string.isRequired,onSelect:r["default"].PropTypes.func.isRequired},handleClick:function(){this.props.onSelect(this.props.chat.chat_id)},render:function(){var e=this.props,t=e.chat,s=e.selectedChat,a=t.chat_id===s?"Chat-selected":"Chat",n=t.last_message_is_read?"LastMessage":"LastMessage-unread",i=new Date(t.last_message_timestamp),o=new Date,u=void 0;return u=o.getYear()!==i.getYear()?(0,c["default"])(i,"mmm d yyyy"):o.getDate()===i.getDate()?(0,c["default"])(i,"h:MM TT"):o.getDate()-1===i.getDate()?"yesterday":(0,c["default"])(i,"mmm d"),r["default"].createElement("div",{className:a,onClick:this.handleClick},r["default"].createElement("div",{className:"ChatInfo"},r["default"].createElement("span",null,t.interlocutor_username),r["default"].createElement("div",{className:"LastMessageTimestamp"},u)),r["default"].createElement("div",{className:n},t.is_interlocutor_typing?r["default"].createElement("div",{className:"LoadingDots"},t.interlocutor_username," is typing"):t.last_message))}})}),require.register("components/MessageForm.jsx",function(e,t,s){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(e,"__esModule",{value:!0});var n=t("react"),r=a(n),i=t("utils/utils"),c=void 0,o=void 0,u=!1;e["default"]=r["default"].createClass({displayName:"MessageForm",propTypes:{chat:r["default"].PropTypes.object.isRequired,onMessage:r["default"].PropTypes.func.isRequired},componentWillMount:function(){var e=this.props.chat;c=new WebSocket("ws://127.0.0.1:8888/tornado_chat/"+e.chat_id+"/")},componentDidMount:function(){var e=this.props.chat;e.last_message_is_read||e.last_message_sender_id.toString()!==e.interlocutor_id.toString()||!function(){var t={type:"READ_MESSAGE",interlocutorId:e.interlocutor_id};(0,i.waitForSocketConnection)(c,function(){c.send(JSON.stringify(t))})}()},componentWillUpdate:function(e){var t=e.chat;t.chat_id!==this.props.chat.chat_id&&(c.close(),c=new WebSocket("ws://127.0.0.1:8888/tornado_chat/"+e.chat.chat_id+"/"))},componentDidUpdate:function(){var e=this.props.chat;e.last_message_is_read||e.last_message_sender_id.toString()!==e.interlocutor_id.toString()||!function(){var t={type:"READ_MESSAGE",interlocutorId:e.interlocutor_id};(0,i.waitForSocketConnection)(c,function(){c.send(JSON.stringify(t))})}()},componentWillUnmount:function(){var e=this.props.chat;u&&(clearTimeout(o),u=!1,c.send(JSON.stringify({type:"IS_USER_TYPING",interlocutorId:e.interlocutor_id})))},handleKeyDown:function(e){if(e.shiftKey&&13==e.keyCode);else if(13==e.keyCode&&(this.refs.send.click(),""!==this.refs.message.value)){var t={type:"SEND_MESSAGE",interlocutorId:this.props.chat.interlocutor_id,message:this.refs.message.value};c.send(JSON.stringify(t)),this.refs.message.value=""}},handleKeyPress:function(){var e=this.props.chat;clearTimeout(o);this.refs.message.value;u||(u=!0,c.send(JSON.stringify({type:"IS_USER_TYPING",interlocutorId:e.interlocutor_id}))),o=setTimeout(function(){u=!1,c.send(JSON.stringify({type:"IS_USER_TYPING",interlocutorId:e.interlocutor_id}))},3e3)},handleClick:function(){if(""!==this.refs.message.value){var e={type:"SEND_MESSAGE",interlocutorId:this.props.chat.interlocutor_id,message:this.refs.message.value};c.send(JSON.stringify(e)),this.refs.message.value=""}},render:function(){return r["default"].createElement("div",{className:"MessageForm"},r["default"].createElement("div",{className:"NewsLine"},this.props.chat.is_interlocutor_typing?r["default"].createElement("div",{className:"LoadingDots"},this.props.chat.interlocutor_username," is typing"):r["default"].createElement("div",null)),r["default"].createElement("textarea",{ref:"message",type:"text",placeholder:"Type your text here",onKeyDown:this.handleKeyDown,onKeyPress:this.handleKeyPress,onKeyUp:this.handleKeyUp}),r["default"].createElement("button",{onClick:this.handleClick},"Send"))}})}),require.register("components/MessagesBlock.jsx",function(e,t,s){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(e,"__esModule",{value:!0});var n=t("react"),r=a(n),i=t("dateformat"),c=a(i),o=t("react-dom"),u=a(o),d=t("utils/utils");e["default"]=r["default"].createClass({displayName:"MessagesBlock",propTypes:{chatMessages:r["default"].PropTypes.array.isRequired,chatId:r["default"].PropTypes.string.isRequired,loadInfo:r["default"].PropTypes.object.isRequired,onStartLoad:r["default"].PropTypes.func.isRequired,onLoadMessages:r["default"].PropTypes.func.isRequired},handleScroll:function(){var e=u["default"].findDOMNode(this.refs.test);console.log(e.scrollTop),0===e.scrollTop&&(this.props.loadInfo.isLoading||(this.props.onStartLoad(this.props.chatId),this.props.onLoadMessages(this.props.chatId)))},render:function(){var e=this.props,t=e.chatMessages,s=(e.chatId,e.loadInfo),a=t.length;return r["default"].createElement("div",{className:"MessagesBlock",ref:"test",onScroll:this.handleScroll},t.map(function(e,n){var i=e.is_read?"Message":"Message-unread",o=new Date(e.timestamp),u=n===a-1,l=void 0;return l=0===n?new Date(t[n].timestamp):new Date(t[n-1].timestamp),r["default"].createElement("div",{className:i,key:"message"+n},u?r["default"].createElement("div",{className:"MessagesBlockDate"},(0,c["default"])(o,"mmmm d, yyyy")):"",r["default"].createElement("div",{className:"MessageInfo"},r["default"].createElement("div",{className:"MessageSender"},e.sender__username),r["default"].createElement("div",{className:"MessageTimestamp"},(0,c["default"])(o,"h:MM:ss TT"))),r["default"].createElement("div",{className:"MessageText"},e.text),(0,d.compareDatesWithoutTime)(l,o)?r["default"].createElement("div",{className:"MessagesBlockDate"},(0,c["default"])(l,"mmmm d, yyyy")):"",s.isLoading?r["default"].createElement("div",null,"loading"):r["default"].createElement("div",null))}))}})}),require.register("components/User.jsx",function(e,t,s){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(e,"__esModule",{value:!0});var n=t("react"),r=a(n);e["default"]=r["default"].createClass({displayName:"User",propTypes:{username:r["default"].PropTypes.string.isRequired,onChatCreate:r["default"].PropTypes.func.isRequired},handleClick:function(){this.props.onChatCreate(this.props.username)},render:function(){var e=this.props.username;return r["default"].createElement("div",{className:"User"},r["default"].createElement("div",null,e),r["default"].createElement("button",{onClick:this.handleClick},"Start chat"))}})}),require.register("container/App.jsx",function(e,t,s){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(e,"__esModule",{value:!0});var n=t("react"),r=a(n),i=t("react-redux"),c=t("actions"),o=t("./ChatsList"),u=a(o),d=t("./ChatWindow"),l=a(d),h=t("./UsersList"),f=a(h),m=r["default"].createClass({displayName:"App",componentWillUpdate:function(e){var t=this;e.currentUser!==this.props.currentUser&&!function(){var s=t.props,a=s.onNewChatMessage,n=s.onMessageRead,r=s.onInterlocutorTyping,i=s.onNewChat,c=new WebSocket("ws://127.0.0.1:8888/chat_app/"+e.currentUser.user_id+"/");c.onmessage=function(e){var t=JSON.parse(e.data);"SEND_MESSAGE"===t.type?a(t.chat_id,t.message):"READ_MESSAGE"===t.type?n(t.chat_id):"IS_USER_TYPING"===t.type?r(t.chat_id):"DISPLAY_CHAT_ON_RECIPIENT_SIDE"===t.type&&i(t.chat)}}()},render:function(){return r["default"].createElement("div",{className:"Container"},r["default"].createElement(u["default"],{selectedChat:this.props.selectedChat}),r["default"].createElement(l["default"],{chats:this.props.chats,selectedChat:this.props.selectedChat,messages:this.props.messages}),r["default"].createElement(f["default"],null))}}),p=function(e){return{currentUser:e.currentUser,chats:e.chats,selectedChat:e.selectedChat,messages:e.messages}},_=function(e){return{onNewChatMessage:function(t,s){e((0,c.addNewChatMessage)(t,s))},onMessageRead:function(t){e((0,c.readChatMessage)(t))},onInterlocutorTyping:function(t){e((0,c.changeIsTypingState)(t))},onNewChat:function(t){e((0,c.addNewChat)(t))}}};e["default"]=(0,i.connect)(p,_)(m)}),require.register("container/ChatWindow.jsx",function(e,t,s){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(e,"__esModule",{value:!0});var n=t("react"),r=a(n),i=t("react-redux"),c=t("actions"),o=t("components/MessagesBlock"),u=a(o),d=t("components/MessageForm"),l=a(d),h=function(e){var t=e.chats,s=e.selectedChat,a=e.messages,n=e.chatMessagesLoadInfo,i=e.onStartLoad,c=e.onChatMessagesLoad;return s&&a[s]?r["default"].createElement("div",{className:"ChatWindow"},r["default"].createElement(u["default"],{chatMessages:a[s],chatId:s,loadInfo:n,onStartLoad:i,onLoadMessages:c}),r["default"].createElement(l["default"],{chat:t[s]})):r["default"].createElement("div",{className:"ChatWindow-empty"})},f=function(e){return{chatMessagesLoadInfo:e.chatMessagesLoadInfo}},m=function(e){return{onStartLoad:function(t){e((0,c.startLoadChatMessages)(t))},onChatMessagesLoad:function(t){e((0,c.loadChatMessages)(t))}}};e["default"]=(0,i.connect)(f,m)(h)}),require.register("container/ChatsList.jsx",function(e,t,s){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(e,"__esModule",{value:!0});var n=t("react"),r=a(n),i=t("react-redux"),c=t("actions"),o=t("components/Chat"),u=a(o),d=function(e){var t=e.chats,s=e.selectedChat,a=e.onChatSelect;return r["default"].createElement("div",{className:"ChatList"},Object.keys(t).sort(function(e,s){return t[e].last_message_timestamp>t[s].last_message_timestamp?-1:t[e].last_message_timestamp<t[s].last_message_timestamp?1:0}).map(function(e){return r["default"].createElement(u["default"],{chat:t[e],selectedChat:s,onSelect:a,key:e})}))},l=function(e){return{chats:e.chats}},h=function(e){return{onChatSelect:function(t){e((0,c.loadChatMessages)(t)),e((0,c.selectChat)(t))}}};e["default"]=(0,i.connect)(l,h)(d)}),require.register("container/UsersList.jsx",function(e,t,s){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(e,"__esModule",{value:!0});var n=t("react"),r=a(n),i=t("react-redux"),c=t("actions"),o=t("components/User"),u=a(o),d=function(e){var t=e.users,s=e.onChatCreate;return r["default"].createElement("div",{className:"UsersList"},t.map(function(e){return r["default"].createElement(u["default"],{username:e.username,onChatCreate:s,key:e.username})}))},l=function(e){return{users:e.users}},h=function(e){return{onChatCreate:function(t){e((0,c.createChat)(t))}}};e["default"]=(0,i.connect)(l,h)(d)}),require.register("initialize.js",function(e,t,s){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}var n=t("react-dom"),r=a(n),i=t("react"),c=a(i),o=t("redux"),u=t("redux-thunk"),d=a(u),l=t("react-redux");t("whatwg-fetch");var h=t("reducer"),f=a(h),m=t("container/App"),p=a(m),_=t("actions");t("es6-promise").polyfill(),t("whatwg-fetch");var g=(0,o.createStore)(f["default"],(0,o.applyMiddleware)(d["default"]));g.dispatch((0,_.initialFetchCurrentUser)()),g.dispatch((0,_.initialFetchUsers)()),g.dispatch((0,_.initialFetchChats)()),document.addEventListener("DOMContentLoaded",function(){var e=document.createElement("div");e.id="app",document.body.appendChild(e),r["default"].render(c["default"].createElement(l.Provider,{store:g},c["default"].createElement(p["default"],null)),e)})}),require.register("reducer.js",function(e,t,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e["default"]=function(){var e=arguments.length<=0||void 0===arguments[0]?a:arguments[0],t=arguments[1],s=void 0,n=void 0,r=void 0,i=void 0;switch(t.type){case"SELECT_CHAT":return Object.assign({},e,{selectedChat:t.chatId});case"ADD_NEW_CHAT_MESSAGE":return n=Object.assign({},e.messages),n[t.chatId]&&(r=Array.from(e.messages[t.chatId]),r.unshift({text:t.message.text,sender__username:t.message.sender_username,timestamp:t.message.timestamp,is_read:!1}),n[t.chatId]=r),s=Object.assign({},e.chats),s[t.chatId].last_message=t.message.text,s[t.chatId].last_message_sender_id=t.message.sender_id,s[t.chatId].last_message_timestamp=t.message.timestamp,s[t.chatId].last_message_is_read=!1,Object.assign({},e,{messages:n},{chats:s});case"READ_CHAT_MESSAGE":if(n=Object.assign({},e.messages),n[t.chatId])for(var c=0;c<n[t.chatId].length&&!n[t.chatId][c].is_read;++c)n[t.chatId][c].is_read=!0;return s=Object.assign({},e.chats),s[t.chatId].last_message_is_read=!0,Object.assign({},e,{messages:n},{chats:s});case"CHANGE_IS_TYPING_STATE":return s=Object.assign({},e.chats),s[t.chatId].is_interlocutor_typing?s[t.chatId].is_interlocutor_typing=!1:s[t.chatId].is_interlocutor_typing=!0,Object.assign({},e,{chats:s});case"ADD_NEW_CHAT":return s=Object.assign({},e.chats),n=Object.assign({},e.messages),s[t.chat.chat_id]=t.chat,r=[{text:t.chat.last_message,sender__username:e.currentUser.username,timestamp:t.chat.last_message_timestamp,is_read:!1}],n[t.chat.chat_id]=r,Object.assign({},e,{chats:s},{messages:n});case"INIT_LOAD_CHAT_MESSAGES_INFO":return i=Object.assign({},e.chatMessagesLoadInfo),i[t.chatId]={pageNumber:1,isLoading:!1},Object.assign({},e,{chatMessagesLoadInfo:i});case"INCREMENT_CHAT_MESSAGE_PAGE_NUMBER":return i=Object.assign({},e.chatMessagesLoadInfo),i[t.chatId].pageNumber+=1,Object.assign({},e,{chatMessagesLoadInfo:i});case"START_LOAD_CHAT_MESSAGES":return i=Object.assign({},e.chatMessagesLoadInfo),i[t.chatId].isLoading=!0,Object.assign({},e,{chatMessagesLoadInfo:i});case"STOP_LOAD_CHAT_MESSAGES":return i=Object.assign({},e.chatMessagesLoadInfo),i[t.chatId].isLoading=!1,Object.assign({},e,{chatMessagesLoadInfo:i});case"RECEIVE_CHAT_MESSAGES":return n=Object.assign({},e.messages),n[t.chatId]?n[t.chatId]=n[t.chatId].concat(t.chatMessages):n[t.chatId]=t.chatMessages,Object.assign({},e,{messages:n});case"RECEIVE_CURRENT_USER":return Object.assign({},e,{currentUser:t.user});case"RECEIVE_USERS":return Object.assign({},e,{users:t.users});case"RECEIVE_CHATS":return Object.assign({},e,{chats:t.chats});default:return e}};var a={currentUser:{},users:[{username:"first"},{username:"second"},{username:"third"}],chats:{},selectedChat:"",messages:{2:[{text:"hello"},{text:"hello"},{text:"hello"},{text:"hello"},{text:"hello"},{text:"hello"},{text:"hello"}]},chatMessagesLoadInfo:{}}}),require.register("utils/apiCalls.js",function(e,t,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.createChat=function(e){return new Promise(function(t,s){fetch("http://127.0.0.1:8000/chat/create_chat/?username="+e,{method:"GET",credentials:"same-origin"}).then(function(e){e.json().then(function(e){return t(e)})})})},e.getCurrentUser=function(){return new Promise(function(e,t){fetch("http://127.0.0.1:8000/chat/get_current_user",{method:"GET",credentials:"same-origin"}).then(function(t){t.json().then(function(t){return e(t)})})})},e.getAllUsers=function(){return new Promise(function(e,t){fetch("http://127.0.0.1:8000/chat/get_all_users",{method:"GET",credentials:"same-origin"}).then(function(t){t.json().then(function(t){return e(t.users)})})})},e.getUserChats=function(){return new Promise(function(e,t){fetch("http://127.0.0.1:8000/chat/get_user_chats",{method:"GET",credentials:"same-origin"}).then(function(t){t.json().then(function(t){return e(t.chats)})})})},e.loadChatMessages=function(e,t){return new Promise(function(s,a){fetch("http://127.0.0.1:8000/chat/load_chat_messages/?page="+t+"&chat_id="+e,{method:"GET",credentials:"same-origin"}).then(function(e){e.json().then(function(e){return s(e.chat_messages)})})})}}),require.register("utils/utils.js",function(e,t,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.waitForSocketConnection=function a(e,t){setTimeout(function(){return 1===e.readyState?void(void 0!==t&&t()):void a(e,t)},5)},e.compareDatesWithoutTime=function(e,t){return e.setHours(0,0,0,0,0),t.setHours(0,0,0,0,0),e>t}}),require.alias("process/browser.js","process"),e=require("process"),require.register("___globals___",function(e,t,s){})}(),require("___globals___");